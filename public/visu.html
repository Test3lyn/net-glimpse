<!DOCTYPE html>
<html lang="en">

<head>
  <title>EtherVisuWeb</title>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.11/p5.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/addons/p5.dom.min.js"></script>
  <script src="assets/javascripts/toxiclibs.min.js"></script>
  <script src="assets/graph.js"></script>
  <script src="assets/p5visu.js"></script>
  <link rel="stylesheet" media="screen" href="/assets/stylesheets/p5visu.css">
  <link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

  <div id="canvasContainer"></div>

  <div id="descriptionContainer">
    <div id="glossaryEther">
      <p><b>Ethernet</b></p>
      <ul>
        <li>
          <div id="box-IPv4" class="glossaryBox"></div>IPv4</li>
        <li>
          <div id="box-IPv6" class="glossaryBox"></div>IPv6</li>
        <li>
          <div id="box-ARP" class="glossaryBox"></div>ARP</li>
        <li>
          <div id="box-RARP" class="glossaryBox"></div>RARP</li>
        <li>
          <div id="box-PPP" class="glossaryBox"></div>PPP</li>
        <li>
          <div id="box-PPPoE-Discovery" class="glossaryBox"></div>PPPoE Discovery Stage</li>
        <li>
          <div id="box-PPPoE-Session" class="glossaryBox"></div>PPPoE Session Stage</li>
        <li>
          <div id="box-MPLS" class="glossaryBox"></div>MPLS</li>
        <li>
          <div id="box-VLAN-tagged-frames" class="glossaryBox"></div>IEEE 802.1Q VLAN-tagged frames</li>
        <li>
          <div id="box-Appletalk" class="glossaryBox"></div>Appletalk</li>
        <li>
          <div id="box-Ether-unknown" class="glossaryBox"></div>unknown</li>
      </ul>
    </div>

    <div id="glossaryIp">
      <p><b>IP</b></p>
      <ul>
        <li>
          <div id="box-TCP" class="glossaryBox"></div>TCP</li>
        <li>
          <div id="box-UDP" class="glossaryBox"></div>UDP</li>
        <li>
          <div id="box-IP-unknown" class="glossaryBox"></div>unknown</li>
      </ul>
    </div>
  </div>

  <script>
    var nif = getQueryParameterByName("nif");
    var urlQueryStr = (nif) ? "?nif=" + nif : "";

    var size = document.body.clientWidth / 2 - 20;
    document.getElementById("glossaryEther").style.width = size + "px";
    document.getElementById("glossaryIp").style.width = size + "px" ;

    // Setup Ethernet
    var configEther = {
      'margin': 0.05,
      'width': size,
      'height': size
    };
    var graphEther = new Graph();
    var visuEther = new Visu(graphEther, configEther);
    var p5Ether = new p5(visuEther.s, 'canvasContainer');

    // Setup IP
    var configIp = {
      'margin': 0.05,
      'width': size,
      'height': size
    };
    var graphIp = new Graph();
    var visuIp = new Visu(graphIp, configIp);
    var p5Ip = new p5(visuIp.s, 'canvasContainer');

    window.setInterval(function () {
      graphEther.removeOldNodesAndEdges();
      graphIp.removeOldNodesAndEdges();
    }, 1000);

    var socket = new WebSocket(
      ((window.location.protocol === "https:") ? "wss://" : "ws://") +
      window.location.host + "/ether" + urlQueryStr);

    socket.onmessage = function (event) {
      var packet = JSON.parse(event.data);
      if (packet.ethernet) {
        handleEther(packet);
      }
      if (packet.ip) {
        handleIp(packet);
      }
    };

    function handleEther(packet) {
      var srcAddr = packet.ethernet.macSrcAddr;
      var dstAddr = packet.ethernet.macDstAddr;
      var srcNodeColor = getColorFromMac(srcAddr);
      var dstNodeColor = getColorFromMac(dstAddr);
      var edgeColor = getColorFromEtherType(packet.ethernet.etherType);
      graphEther.fill(srcAddr, dstAddr, srcNodeColor, dstNodeColor, edgeColor);
    }

    function handleIp(packet) {
      var srcAddr = packet.ip.srcAddr.substring(1);
      var dstAddr = packet.ip.dstAddr.substring(1);
      var protocol = packet.ip.protocol;
      var srcNodeColor, dstNodeColor;
      if (packet.ip.version === "IPv4") {
        srcNodeColor = getColorFromIPv4(srcAddr);
        dstNodeColor = getColorFromIPv4(dstAddr);
      } else if (packet.ip.version === "IPv6") {
        srcNodeColor = getColorFromIPv6(srcAddr);
        dstNodeColor = getColorFromIPv6(dstAddr);
      }
      var edgeColor = getColorFromIpProtocol(packet.ip.protocol);
      graphIp.fill(srcAddr, dstAddr, srcNodeColor, dstNodeColor, edgeColor);
    }

    function getQueryParameterByName(name) {
      var url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
  </script>

  <script src="assets/color.js"></script>
</body>

</html>